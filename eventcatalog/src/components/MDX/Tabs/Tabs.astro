---
interface TabItem {
  title: string;
  content: string;
  id: number;
}

interface Props {
  title?: string;
}

const { title } = Astro.props;

const tabItems: TabItem[] = await Promise.all(
  (await Astro.slots.render('default'))
    .split('</li>')
    .filter((item: string) => item.trim())
    .map(async (item: string, index: number) => {
      const titleMatch = item.match(/button>([^<]+)</);
      let title = titleMatch ? titleMatch[1].trim() : ``;
      title = title || `Tab ${index + 1}`;
      const content = item.replace(/<button>[^<]+<\/button>/, '');
      return {
        title,
        content,
        id: index + 1,
      };
    })
);

// Generate a unique ID for this tabs instance
const tabsId = Math.random().toString(36).substring(2, 9);
---

<div class="bg-white dark:bg-gray-800 text-gray-800 dark:text-gray-100 pb-10 not-prose rounded-lg" data-tabs-container={tabsId}>
  {title && <h2 class="text-2xl font-bold text-gray-800 dark:text-gray-100 mb-6">{title}</h2>}

  {/* Tab List */}
  <div class="">
    <nav class="-mb-px flex" aria-label="Tabs">
      {
        tabItems.map((item) => (
          <button
            class="whitespace-nowrap py-4 px-1 border-b-2 px-6 font-bold text-sm border-transparent text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200 hover:border-gray-300 dark:hover:border-gray-500 hover:bg-gray-100 dark:hover:bg-gray-700 focus:outline-none"
            data-tab={item.id}
            aria-selected="false"
          >
            {item.title}
          </button>
        ))
      }
    </nav>
  </div>

  {/* Tab Panels */}
  <div class="mt-4">
    {
      tabItems.map((item) => (
        <div class="hidden tab-content" data-tab-content={item.id} role="tabpanel">
          <Fragment set:html={item.content} />
        </div>
      ))
    }
  </div>
</div>

<script>
  function initTabs(container: HTMLElement): void {
    const tabs: NodeListOf<HTMLButtonElement> = container.querySelectorAll('[data-tab]');
    const panels: NodeListOf<HTMLElement> = container.querySelectorAll('[data-tab-content]');

    const activeClasses = ['text-purple-600', 'dark:text-purple-400', 'border-purple-600', 'dark:border-purple-400'];
    const inactiveClasses = ['text-gray-500', 'dark:text-gray-400', 'border-transparent'];

    // Show first tab by default
    activeClasses.forEach(cls => tabs[0]?.classList.add(cls));
    inactiveClasses.forEach(cls => tabs[0]?.classList.remove(cls));
    panels[0]?.classList.remove('hidden');

    tabs.forEach((tab: HTMLButtonElement) => {
      tab.addEventListener('click', () => {
        // Remove active states
        tabs.forEach((t: HTMLButtonElement) => {
          activeClasses.forEach(cls => t.classList.remove(cls));
          inactiveClasses.forEach(cls => t.classList.add(cls));
        });
        panels.forEach((p: HTMLElement) => p.classList.add('hidden'));

        // Set active states
        inactiveClasses.forEach(cls => tab.classList.remove(cls));
        activeClasses.forEach(cls => tab.classList.add(cls));

        // Show corresponding panel
        const tabId = tab.getAttribute('data-tab');
        container.querySelector(`[data-tab-content="${tabId}"]`)?.classList.remove('hidden');
      });
    });
  }

  // We use `ViewTransitions`
  // Whenever happens a navigation, from view transitions or native to the browser, init the tabs.
  document.addEventListener('astro:page-load', () => {
    // Initialize all tab containers
    document.querySelectorAll('[data-tabs-container]').forEach((container: Element) => {
      initTabs(container as HTMLElement);
    });
  });
</script>
